# Separation of Concerns

**Parent**: [Project Structure](./project_structure.md)  
**Status**: Proposal  
**Created**: 2025-10-23  

---

## 🎯 Core Principle

**Business logic should never know about HTML, CSS, or JavaScript.**

Each layer has a specific responsibility and clear boundaries:

---

## 📂 Layer Definitions

### 1️⃣ `src/internal/*` - Business Logic Layer

**Responsibility**: Domain logic, data processing, business rules

**Allowed**:
- ✅ Define data structures (models)
- ✅ Implement business operations
- ✅ Database queries
- ✅ API calls to external services
- ✅ Data validation and transformation
- ✅ Call methods from `pkg/ui.go`

**Forbidden**:
- ❌ Direct HTML generation
- ❌ CSS styling
- ❌ JavaScript code
- ❌ Import `src/pkg/uigoh/*` directly (only through `pkg/ui.go`)
- ❌ Know about file paths in `web/`

**Example Structure**:
```
src/internal/
├── patientCare/
│   ├── patient.go          # Patient struct
│   ├── repository.go       # Database operations
│   ├── service.go          # Business logic
│   └── ui.go               # RenderUI() method - uses pkg/ui.go
│
├── servicesPage/
│   ├── service.go          # Service struct
│   ├── repository.go
│   └── ui.go               # RenderUI() method
│
└── homePage/
    ├── content.go
    └── ui.go               # RenderUI() method
```

---

### 2️⃣ `src/pkg/` - Public API Layer

**Responsibility**: Expose stable interfaces to internal modules

**Contains**:
- `ui.go` - **Single entry point** for all UI operations
- `modules.go` - Module registry
- Other shared utilities (future)

**`pkg/ui.go` Structure**:
```go
package pkg

import "github.com/cdvelop/monjitaschillan.cl/pkg/uigoh"

// UI is the singleton instance exposed to internal modules
var UI = uigoh.New()
```

**Why this separation?**
- Internal modules only see `pkg/ui.go`
- `uigoh` implementation details are hidden
- Easy to swap implementations later
- Clear API surface

---

### 3️⃣ `src/pkg/uigoh/*` - UI Implementation Layer

**Responsibility**: Implement all UI components and rendering logic

**Allowed**:
- ✅ Generate HTML strings
- ✅ Generate CSS strings
- ✅ Generate JavaScript strings
- ✅ Manage component composition
- ✅ Handle HTML escaping
- ✅ File I/O for rendering

**Forbidden**:
- ❌ Business logic
- ❌ Database operations
- ❌ Import from `internal/*`
- ❌ Know about specific business domains (patients, services, etc.)

**Files** (all at root level):
```
src/pkg/uigoh/
├── uigoh.go         # Main HtmlUI manager, New()
├── page.go          # Page builder
├── nav.go           # Navigation component
├── card.go          # Card component
├── carousel.go      # Carousel component
├── form.go          # Form component
├── section.go       # Section component
├── button.go        # Button component
├── css.go           # CSS utilities
├── js.go            # JS utilities
└── utils.go         # HTML escaping, etc.
```

---

### 4️⃣ `src/web/ui/` - Generated Assets Layer

**Responsibility**: Store generated HTML/CSS/JS before minification

**Contains** (generated, not committed):
- `index.html` - Full page HTML
- `style.css` - Accumulated CSS from all components
- `script.js` - Accumulated JS from all components

**Lifecycle**:
1. `GenerateSite()` writes files here
2. `golite` watches this directory
3. Changes trigger minification

---

### 5️⃣ `src/web/public/` - Served Assets Layer

**Responsibility**: Serve minified, production-ready files

**Contains** (generated by `golite`):
- `index.html` - Minified HTML
- `style.css` - Minified CSS
- `script.js` - Minified JS
- `icons.svg` - Static SVG icons
- `img/` - Static images

**Served by**: `src/cmd/appserver/main.go`

---

## 🔄 Data Flow Example

### Scenario: Render Services Page

```
┌─────────────────────────────────────────────────────────────┐
│ 1. main.go initializes                                       │
│    - Loads modules from pkg/modules.go                       │
│    - Calls each module's RenderUI()                          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. internal/servicesPage/ui.go                               │
│    func (m *Module) RenderUI(params ...any) (string, error) │
│    {                                                          │
│        page := ui.UI.NewPage("Services")                     │
│        services := m.GetServices() // Business logic         │
│        for _, svc := range services {                        │
│            card := ui.UI.Card(svc.Title, svc.Desc, svc.Icon) │
│            page.AddSection(card)                             │
│        }                                                      │
│        return page.RenderHTML(), nil                         │
│    }                                                          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. pkg/ui.go forwards to uigoh                               │
│    var UI = uigoh.New()                                      │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. pkg/uigoh/card.go generates HTML                          │
│    - Builds HTML string                                      │
│    - Escapes user input                                      │
│    - Auto-adds CSS to page                                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. main.go calls ui.UI.GenerateSite()                        │
│    - Writes src/web/ui/index.html                            │
│    - Writes src/web/ui/style.css                             │
│    - Writes src/web/ui/script.js                             │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. golite watches src/web/ui/                                │
│    - Detects changes                                         │
│    - Minifies files                                          │
│    - Copies to src/web/public/                               │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. Browser requests from appserver                           │
│    - Serves from src/web/public/                             │
│    - index.html, style.css, script.js                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚫 Dependency Rules

### Allowed Dependencies

```
internal/* ──────▶ pkg/ui.go
                      │
                      ▼
                  pkg/uigoh/*
                      │
                      ▼
                  src/web/ui/  (file system)
```

### Forbidden Dependencies

```
❌ internal/* ──────▶ pkg/uigoh/*  (must go through pkg/ui.go)
❌ pkg/uigoh/* ─────▶ internal/*   (no business logic knowledge)
❌ internal/* ──────▶ src/web/*    (no direct file operations)
```

---

## 📋 Module Interface Contract

### Required Method (Optional)
```go
type Module interface {
    RenderUI(params ...any) (string, error)
}
```

**Notes**:
- Modules **may** implement `RenderUI()` if they have UI
- Some modules may be pure business logic (no UI)
- Parameters are variadic for flexibility

---

## 🧩 Internal Module Structure

### Example: `internal/patientCare/`

```go
// patient.go - Domain model
package patientCare

type Patient struct {
    ID        int
    Name      string
    Age       int
    Condition string
}
```

```go
// repository.go - Data layer
package patientCare

type Repository struct {
    db *sql.DB
}

func (r *Repository) GetPatients() ([]Patient, error) {
    // Database query
}
```

```go
// service.go - Business logic
package patientCare

type Service struct {
    repo *Repository
}

func (s *Service) GetActivePatients() ([]Patient, error) {
    patients, err := s.repo.GetPatients()
    if err != nil {
        return nil, err
    }
    
    // Business rule: filter active patients
    active := filterActive(patients)
    return active, nil
}
```

```go
// ui.go - UI rendering (ONLY uses pkg/ui.go)
package patientCare

import (
    "github.com/cdvelop/monjitaschillan.cl/pkg"
    "strings"
)

type Module struct {
    service *Service
}

func (m *Module) RenderUI(params ...any) (string, error) {
    page := pkg.UI.NewPage("Patient Care")
    
    // Get data from business layer
    patients, err := m.service.GetActivePatients()
    if err != nil {
        return "", err
    }
    
    // Build UI using only pkg.UI methods
    var content strings.Builder
    content.WriteString("<section id=\"patientcare\" class=\"page\">\n")
    content.WriteString("  <h1>Active Patients</h1>\n")
    content.WriteString("  <div class=\"card-container\">\n")
    
    for _, patient := range patients {
        // Use UI components - CSS auto-added
        card := pkg.UI.Card(
            patient.Name,
            patient.Condition,
            "icon-patient",
        )
        content.WriteString(card)
    }
    
    content.WriteString("  </div>\n")
    content.WriteString("</section>\n")
    
    page.AddSection(content.String())
    
    return page.RenderHTML(), nil
}
```

---

## ✅ Best Practices

### DO ✅

1. **Keep business logic pure**
   ```go
   // Good - pure business logic
   func CalculatePatientRisk(age int, conditions []string) float64 {
       // No UI concerns
   }
   ```

2. **Use UI methods for presentation**
   ```go
   // Good - UI is delegated
   html := ui.UI.Card(title, desc, icon)
   ```

3. **Pass data, not presentation**
   ```go
   // Good - struct is data-only
   type Patient struct {
       Name      string
       Condition string
       // No HTML/CSS properties
   }
   ```

### DON'T ❌

1. **Don't mix HTML in business logic**
   ```go
   // Bad - HTML in business layer
   func GetPatientHTML(p Patient) string {
       return "<div>" + p.Name + "</div>" // ❌
   }
   ```

2. **Don't import uigoh directly**
   ```go
   // Bad - bypasses public API
   import "github.com/.../pkg/uigoh" // ❌
   
   // Good - use public API
   import "github.com/.../pkg" // ✅
   ```

3. **Don't store UI state in business models**
   ```go
   // Bad - mixing concerns
   type Patient struct {
       Name      string
       CSSClass  string // ❌ UI concern
       IsVisible bool   // ❌ UI state
   }
   ```

---

## 🧪 Testing Separation

### Business Logic Tests (No UI)
```go
// internal/patientCare/service_test.go
func TestGetActivePatients(t *testing.T) {
    service := NewService(mockRepo)
    patients, err := service.GetActivePatients()
    
    // Test business logic only
    assert.NoError(t, err)
    assert.Equal(t, 3, len(patients))
}
```

### UI Component Tests (No Business Logic)
```go
// pkg/uigoh/card_test.go
func TestCardRender(t *testing.T) {
    card := &CardConfig{
        Title: "Test",
        Description: "Desc",
    }
    
    html := card.RenderHTML()
    
    // Test HTML structure only
    assert.Contains(t, html, "Test")
    assert.Contains(t, html, "<div class=\"card\">")
}
```

### Integration Tests (Full Stack)
```go
// internal/patientCare/ui_test.go
func TestRenderUI(t *testing.T) {
    module := &Module{service: mockService}
    
    html, err := module.RenderUI()
    
    // Test integration
    assert.NoError(t, err)
    assert.Contains(t, html, "Active Patients")
}
```

---

## 🔍 Code Review Checklist

When reviewing code, verify:

- [ ] No HTML strings in `internal/*` (except `ui.go`)
- [ ] All UI calls go through `pkg.UI.*`
- [ ] No `import "pkg/uigoh"` in internal modules
- [ ] Business models are data-only (no CSS/HTML fields)
- [ ] `uigoh` components don't import `internal/*`
- [ ] Clear separation between data and presentation

---

## 📊 Metrics for Success

Track these to ensure separation is maintained:

| Metric | Target | Check |
|--------|--------|-------|
| HTML strings in `internal/*` (excluding `ui.go`) | 0 | `grep -r "WriteString(\"<" internal/` |
| Direct `uigoh` imports in `internal/*` | 0 | `grep -r "pkg/uigoh" internal/` |
| Business logic in `uigoh/*` | 0 | Manual review |

---

## 🚀 Benefits of This Separation

1. **Testability**: Business logic testable without UI
2. **Flexibility**: Swap UI library without changing business code
3. **Clarity**: Easy to understand where things belong
4. **Scalability**: Add modules without touching UI system
5. **Team Workflow**: Backend/Frontend devs can work independently

---

**Next**: [Module System](./module_system.md) - How modules are registered and auto-rendered
